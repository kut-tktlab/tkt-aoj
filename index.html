<html>
<head>
<title>AOJ Scoreboard for Takata Lab</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>
// The following code is partly cited from:
// http://www.ezgate-mt.sakura.ne.jp/jquery/109.html

var userList = [
  // 'shioshiota',  // a sample user of AOJ
  'ytakata',
  'nyamadori',
  'FSharper',
  'fuka88k',
  'takasyou',
  'nosan',
  'nt1993',
];
var userDataList = [];

var aojurl = 'http://judge.u-aizu.ac.jp/onlinejudge';
var scoreboards = [
  '#scoreboard_total_table',
  '#scoreboard_weekly_table',
  '#scoreboard_today_table'
];

var today = new Date();
var beginDay = today.getTime() -
   (today.getHours() * 1000 * 60 * 60
  + today.getMinutes() * 1000 * 60
  + today.getSeconds() * 1000
  + today.getMilliseconds());
var beginWeek = beginDay - today.getDay() * 1000 * 60 * 60 * 24;

// bootstrap
$(function () {
  loadAllUsers();
});

function loadAllUsers() {
  for (var i = 0; i < userList.length; i++) {
    loadUserData(userList[i]);
  }
}

// Load the data of one user via the AOJ API.
// AOJ API is documented at: http://judge.u-aizu.ac.jp/onlinejudge/api.jsp
function loadUserData(user) {
  var aojapiurl = aojurl + '/webservice/user?id=';
  $.ajax({
    url: aojapiurl + user,
    type: 'GET',
    dataType: 'xml',
    timeout: 1000,
    success: parseUserData
  });
}

function parseUserData(xml, status) {
  if (status != 'success') { return; }

  var user = $(xml).children('user');
  var status = user.children('status');
  var solved = user.children('solved_list');
  var weekly = 0;
  var today = 0;

  var last = null;
  if (solved != null) {
    solved.children('problem').each(function () {
      var submissiondate = Number($(this).children('submissiondate').text());
      if (last == null ||
          Number(last.children('submissiondate').text()) < submissiondate)
      {
        last = $(this);
      }
      if (beginWeek < submissiondate) {
        weekly += 1;
      }
      if (beginDay < submissiondate) {
        today += 1;
      }
    });
  }
  userDataList.push({
    id: user.children('id').text(),
    total: status.children('solved').text(),
    weekly: weekly,
    today: today,
    last: last == null ? null : {
      id: last.children('id').text(),
      language: last.children('language').text(),
      submissiondate: last.children('submissiondate').text()
    }
  });
  if (userDataList.length == userList.length) {
    printScoreBoard(userDataList, 'total', '#scoreboard_total_table');
    printScoreBoard(userDataList, 'weekly', '#scoreboard_weekly_table');
    printScoreBoard(userDataList, 'today', '#scoreboard_today_table');
  }
}

// Display a horizontal bar graph using CSS border-left.
function printGraph(nSolved) {
  return ' style="' +
           'border-left: solid ' + nSolved + 'px #4bf;' +
           'padding-left: 5px;' +
         '" class="graph">' + nSolved;
}

function printUser(id) {
  var aojuserurl = aojurl + '/user.jsp?id=' + id + '#1';
  return '<a href="' + aojuserurl + '">' + id + '</a>';
}

function printProblem(id) {
  var aojproburl = aojurl + '/description.jsp?id=' + id;
  return '<a href="' + aojproburl + '">#' + id + '</a>';
}

function printDate(time) {
  var d = new Date(Number(time));
  return d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() +
         ' ' + d.getHours() + ':' + ("0" + d.getMinutes()).substr(-2);
}

function printScoreBoard(datalist, target, tableId) {
  datalist.sort(function(a, b) { return b[target] - a[target]; });
  datalist.forEach(function(user) {
    $('<tr>' +
        '<td>' + printUser(user.id) + '</td>' +
        '<td ' + printGraph(user[target]) + '</td>' +
        '<td>' + (user.last == null || (user[target] == 0) ? '' :
          '(' + printProblem(user.last.id) +
          ' ' + user.last.language +
          ' ' + printDate(user.last.submissiondate) +
          ')') +
        '</td>' +
      '</tr>').appendTo(tableId);
  });
}

function setTableEnabled(name) {
  var tables = scoreboards.concat();

  tables.splice(tables.indexOf(name), 1);
  tables.forEach(function (tbl) {
    $(tbl).hide();
  });
  $(name).show();
}

</script>
<style type="text/css">
  table.scoreboard tr th {
    text-align: left;
    background: #eee;
  }
  table.scoreboard tr td#graph {
    padding-right: 5px;
  }
</style>
</head>
<body>
  <h1>AOJ Scoreboard</h1>
  <h2># of solved problems</h2>

  <h3>Total</h3>
  <table class="scoreboard" id="scoreboard_total_table">
  <tbody>
    <tr>
      <th>id</th>
      <th>solved</th>
      <th>last problem, language, and date</th>
    </tr>
  </tbody>
  </table>

  <h3>This week</h3>
  <table class="scoreboard" id="scoreboard_weekly_table">
  <tbody>
    <tr>
      <th>id</th>
      <th>solved</th>
      <th>last problem, language, and date</th>
    </tr>
  </tbody>
  </table>

  <h3>Today</h3>
  <table class="scoreboard" id="scoreboard_today_table">
  <tbody>
    <tr>
      <th>id</th>
      <th>solved</th>
      <th>last problem, language, and date</th>
    </tr>
  </tbody>
  </table>

  <h2>Links</h2>
  <ul>
    <li><a href="http://judge.u-aizu.ac.jp/onlinejudge/index.jsp"
           >AOJ: Aizu Online Judge</a>
      <ul>
        <li><a href="http://judge.u-aizu.ac.jp/onlinejudge/api.jsp"
               >Application Program Interface</a></li>
        <li><a href="http://aoj-problem-category-list.appspot.com"
               >AOJ Problems by Category</a> (third party site)</li>
      </ul>
    </li>
    <li><a href="http://www.info.kochi-tech.ac.jp/y-takata/index.php?Local%2FAOJ"
           >Takatalab - Local/AOJ</a>
    </li>
  </ul>

  <h2>Note</h2>
  The source code of this Web site is hosted by <a href="https://github.com/"
  >GitHub</a>.
  Please contact ytakata for becoming a contributer.<br />
  Repository: <code><a href="https://github.com/ytakata69/tkt-aoj/"
  >https://github.com/ytakata69/tkt-aoj/</a></code><br />
  When you push a change to the above repository,
  it will be automatically deployed on the Azure Websites.
</body>
</html>
